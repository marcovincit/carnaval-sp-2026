<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Blocos de Carnaval SP 2026</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
      color: #1c1c1e;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      z-index: 1;
    }

    /* Header */
    #header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: calc(52px + env(safe-area-inset-top));
      padding-top: env(safe-area-inset-top);
      background: rgba(255, 255, 255, 0.72);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-left: 20px;
      padding-right: 16px;
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.12);
    }
    #header h1 {
      font-size: 17px;
      font-weight: 600;
      color: #1c1c1e;
      letter-spacing: -0.2px;
    }
    #btn-locate {
      width: 38px; height: 38px;
      border: none;
      background: rgba(120, 120, 128, 0.12);
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.2s ease;
    }
    #btn-locate:active { background: rgba(120, 120, 128, 0.2); }
    #btn-locate svg { width: 20px; height: 20px; color: #007AFF; }
    #btn-locate.active { background: #007AFF; }
    #btn-locate.active svg { color: #fff; }

    /* Date Filter */
    #date-filter {
      position: fixed;
      top: calc(52px + env(safe-area-inset-top));
      left: 0; right: 0;
      z-index: 1000;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      white-space: nowrap;
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.72);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.12);
    }
    #date-filter::-webkit-scrollbar { display: none; }
    .date-pill {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 14px;
      border-radius: 10px;
      border: none;
      background: rgba(120, 120, 128, 0.08);
      cursor: pointer;
      margin-right: 8px;
      transition: all 0.2s ease;
      min-width: 54px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .date-pill.active {
      background: #007AFF;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }
    .date-pill .day-name {
      font-size: 12px;
      font-weight: 600;
      color: #1c1c1e;
      line-height: 1.3;
    }
    .date-pill .day-date {
      font-size: 10px;
      color: #8e8e93;
      line-height: 1.3;
    }
    .date-pill.active .day-name,
    .date-pill.active .day-date { color: #fff; }

    /* Type Filter */
    #type-filter {
      position: fixed;
      top: calc(52px + 50px + env(safe-area-inset-top));
      left: 0; right: 0;
      z-index: 1000;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      white-space: nowrap;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.72);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
    }
    #type-filter::-webkit-scrollbar { display: none; }
    .type-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 8px;
      border: none;
      background: rgba(120, 120, 128, 0.08);
      cursor: pointer;
      margin-right: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #1c1c1e;
      transition: all 0.2s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .type-chip .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .type-chip.inactive {
      opacity: 0.35;
    }

    /* Bloco Count */
    #bloco-count {
      position: fixed;
      bottom: calc(16px + env(safe-area-inset-bottom));
      left: 16px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.8);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      color: #1c1c1e;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(0, 0, 0, 0.06);
    }

    /* Inline Detail Panel - sits below filters */
    #detail-panel {
      position: fixed;
      left: 0; right: 0;
      z-index: 999;
      background: rgba(255, 255, 255, 0.88);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.12);
      padding: 12px 16px;
      display: none;
      overflow-y: auto;
      max-height: 40vh;
    }
    #detail-panel.visible {
      display: block;
    }
    #detail-panel .detail-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    #detail-panel .detail-info {
      flex: 1;
      min-width: 0;
    }
    #detail-close {
      width: 28px; height: 28px;
      border: none;
      background: rgba(120, 120, 128, 0.12);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
      font-size: 14px;
      color: #8e8e93;
      line-height: 1;
    }
    #detail-close:active { background: rgba(120, 120, 128, 0.2); }
    .tipo-badge {
      display: inline-block;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      padding: 2px 7px;
      border-radius: 4px;
    }
    #detail-panel h2 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 1px;
      line-height: 1.25;
      color: #1c1c1e;
      letter-spacing: -0.2px;
    }
    .detail-bairro {
      font-size: 13px;
      color: #8e8e93;
      margin-bottom: 8px;
    }
    .detail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 16px;
      font-size: 13px;
      color: #1c1c1e;
      margin-bottom: 4px;
    }
    .detail-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .detail-meta .meta-label {
      color: #8e8e93;
      font-weight: 500;
    }
    #btn-route {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 8px;
      padding: 7px 14px;
      border: none;
      background: #007AFF;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    #btn-route:active {
      background: #0062d1;
      transform: scale(0.97);
    }
    #btn-route.active {
      background: #34C759;
    }

    /* Leaflet overrides */
    .bloco-marker { background: none !important; border: none !important; }
    .bloco-tooltip {
      background: rgba(255, 255, 255, 0.92);
      -webkit-backdrop-filter: blur(8px);
      backdrop-filter: blur(8px);
      border: none;
      border-radius: 6px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #1c1c1e;
      white-space: nowrap;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1), 0 0 0 0.5px rgba(0, 0, 0, 0.04);
    }
    .bloco-tooltip::before { display: none; }

    .custom-cluster {
      background: none !important;
      border: none !important;
    }
    .cluster-icon {
      width: 38px;
      height: 38px;
      background: #007AFF;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      border: 2.5px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08), 0 0 0 0.5px rgba(0, 0, 0, 0.06) !important;
      border-radius: 12px !important;
      overflow: hidden;
    }
    .leaflet-control-zoom a {
      width: 36px !important;
      height: 36px !important;
      line-height: 36px !important;
      font-size: 18px !important;
      color: #007AFF !important;
      border-bottom: 0.5px solid rgba(0, 0, 0, 0.08) !important;
      background: rgba(255, 255, 255, 0.85) !important;
    }
    .leaflet-control-zoom a:hover {
      background: rgba(120, 120, 128, 0.12) !important;
      color: #007AFF !important;
    }
    .leaflet-control-zoom a:last-child {
      border-bottom: none !important;
    }

    /* User location - prominent pulse */
    @keyframes pulse-inner {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
      100% { transform: translate(-50%, -50%) scale(3.5); opacity: 0; }
    }
    @keyframes pulse-outer {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
      100% { transform: translate(-50%, -50%) scale(5); opacity: 0; }
    }
    .user-pulse-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .user-ring-inner {
      position: absolute;
      top: 50%; left: 50%;
      width: 24px; height: 24px;
      background: rgba(0, 122, 255, 0.3);
      border: 2px solid rgba(0, 122, 255, 0.4);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse-inner 1.5s ease-out infinite;
    }
    .user-ring-outer {
      position: absolute;
      top: 50%; left: 50%;
      width: 24px; height: 24px;
      background: rgba(0, 122, 255, 0.15);
      border: 1px solid rgba(0, 122, 255, 0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse-outer 2.5s ease-out infinite;
      animation-delay: 0.3s;
    }

  </style>
</head>
<body>

  <header id="header">
    <h1>Carnaval SP 2026</h1>
    <button id="btn-locate" aria-label="Minha localização">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
      </svg>
    </button>
  </header>

  <nav id="date-filter"></nav>
  <div id="type-filter"></div>
  <div id="detail-panel"><div id="detail-content"></div></div>
  <div id="map"></div>
  <div id="bloco-count"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="blocos.js"></script>
  <script>
    // ===== CONFIG =====
    const TYPE_COLORS = {
      'Tradicional': '#6366F1',
      'Megabloco':   '#F59E0B',
      'Afro':        '#10B981',
      'Rock':        '#EF4444',
      'LGBTQIA+':    '#EC4899'
    };

    const TYPE_LABELS = {
      'Tradicional': 'Tradicional',
      'Megabloco':   'Megabloco',
      'Afro':        'Afro',
      'Rock':        'Rock',
      'LGBTQIA+':    'LGBTQIA+'
    };

    // ===== UTILS =====
    function hexToRgb(hex) {
      var r = parseInt(hex.slice(1, 3), 16);
      var g = parseInt(hex.slice(3, 5), 16);
      var b = parseInt(hex.slice(5, 7), 16);
      return r + ',' + g + ',' + b;
    }

    // ===== STATE =====
    let map, markerClusterGroup;
    let userMarker = null, userRing = null;
    let activeRoute = null, activeRouteMarkers = [];
    let currentDate = null;
    let activeTypes = new Set(Object.keys(TYPE_COLORS));
    let selectedBloco = null;

    // ===== INIT =====
    function init() {
      initMap();
      buildDateFilter();
      buildTypeFilter();
      setupEventListeners();
      // autoSelectToday calls filterBlocos internally if today matches;
      // otherwise fall back to showing all blocos
      if (!autoSelectToday()) {
        filterBlocos();
      }
    }

    // ===== MAP =====
    function initMap() {
      map = L.map('map', {
        center: [-23.5505, -46.6340],
        zoom: 13,
        zoomControl: false,
        attributionControl: true
      });

      L.control.zoom({ position: 'bottomright' }).addTo(map);

      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
        maxZoom: 19
      }).addTo(map);

      markerClusterGroup = L.markerClusterGroup({
        maxClusterRadius: 45,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        iconCreateFunction: function(cluster) {
          var count = cluster.getChildCount();
          return L.divIcon({
            html: '<div class="cluster-icon">' + count + '</div>',
            className: 'custom-cluster',
            iconSize: [38, 38]
          });
        }
      });
      map.addLayer(markerClusterGroup);

      // Toggle tooltip visibility on zoom
      map.on('zoomend', updateTooltipVisibility);
    }

    function updateTooltipVisibility() {
      var zoom = map.getZoom();
      var tooltips = document.querySelectorAll('.bloco-tooltip');
      for (var i = 0; i < tooltips.length; i++) {
        tooltips[i].style.display = zoom >= 14 ? '' : 'none';
      }
    }

    // ===== MARKERS =====
    function createBlocoIcon(tipo) {
      var color = TYPE_COLORS[tipo] || '#6B7280';
      var size = tipo === 'Megabloco' ? 22 : 16;
      return L.divIcon({
        className: 'bloco-marker',
        html: '<div style="width:' + size + 'px;height:' + size + 'px;background:' + color +
              ';border:2.5px solid #fff;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,0.2);"></div>',
        iconSize: [size + 4, size + 4],
        iconAnchor: [(size + 4) / 2, (size + 4) / 2]
      });
    }

    // ===== FILTERS =====
    function buildDateFilter() {
      var dates = [];
      var dateSet = {};
      BLOCOS_DATA.blocos.forEach(function(b) {
        if (!dateSet[b.dia]) {
          dateSet[b.dia] = { dia: b.dia, dia_semana: b.dia_semana, count: 0 };
          dates.push(dateSet[b.dia]);
        }
        dateSet[b.dia].count++;
      });

      dates.sort(function(a, b) {
        var pa = a.dia.split('/'), pb = b.dia.split('/');
        var da = new Date(+pa[2], +pa[1]-1, +pa[0]);
        var db = new Date(+pb[2], +pb[1]-1, +pb[0]);
        return da - db;
      });

      var container = document.getElementById('date-filter');

      // "Todos" pill
      var allPill = document.createElement('div');
      allPill.className = 'date-pill active';
      allPill.dataset.date = '';
      allPill.innerHTML = '<span class="day-name">Todos</span><span class="day-date">' +
                          BLOCOS_DATA.blocos.length + ' blocos</span>';
      allPill.addEventListener('click', function() { selectDate(null, this); });
      container.appendChild(allPill);

      dates.forEach(function(d) {
        var pill = document.createElement('div');
        pill.className = 'date-pill';
        pill.dataset.date = d.dia;
        var parts = d.dia.split('/');
        var shortDay = d.dia_semana.substring(0, 3);
        pill.innerHTML = '<span class="day-name">' + shortDay + '</span><span class="day-date">' +
                         parts[0] + '/' + parts[1] + '</span>';
        pill.addEventListener('click', function() { selectDate(d.dia, this); });
        container.appendChild(pill);
      });
    }

    function selectDate(date, el) {
      currentDate = date;
      var pills = document.querySelectorAll('.date-pill');
      for (var i = 0; i < pills.length; i++) {
        pills[i].classList.remove('active');
      }
      el.classList.add('active');
      hideDetail();
      filterBlocos();
    }

    function buildTypeFilter() {
      var container = document.getElementById('type-filter');
      var types = Object.keys(TYPE_COLORS);
      types.forEach(function(tipo) {
        var chip = document.createElement('div');
        chip.className = 'type-chip';
        chip.dataset.tipo = tipo;
        chip.innerHTML = '<span class="dot" style="background:' + TYPE_COLORS[tipo] + '"></span>' +
                         TYPE_LABELS[tipo];
        chip.addEventListener('click', function() { toggleType(tipo, this); });
        container.appendChild(chip);
      });
    }

    function toggleType(tipo, el) {
      if (activeTypes.has(tipo)) {
        activeTypes.delete(tipo);
        el.classList.add('inactive');
      } else {
        activeTypes.add(tipo);
        el.classList.remove('inactive');
      }
      hideDetail();
      filterBlocos();
    }

    function filterBlocos() {
      markerClusterGroup.clearLayers();
      clearRoute();

      var filtered = BLOCOS_DATA.blocos.filter(function(b) {
        var dateMatch = currentDate === null || b.dia === currentDate;
        var typeMatch = activeTypes.has(b.tipo);
        return dateMatch && typeMatch;
      });

      filtered.forEach(function(bloco) {
        var marker = L.marker([bloco.lat, bloco.lng], {
          icon: createBlocoIcon(bloco.tipo)
        });

        marker.bindTooltip(bloco.nome, {
          permanent: true,
          direction: 'right',
          offset: [8, 0],
          className: 'bloco-tooltip'
        });

        marker.on('click', function() {
          showBlocoDetail(bloco);
          map.setView([bloco.lat, bloco.lng], Math.max(map.getZoom(), 15), { animate: true });
        });

        markerClusterGroup.addLayer(marker);
      });

      // Update count
      document.getElementById('bloco-count').textContent = filtered.length + ' bloco' + (filtered.length !== 1 ? 's' : '');

      // Fit bounds
      if (filtered.length > 0) {
        var bounds = L.latLngBounds(filtered.map(function(b) { return [b.lat, b.lng]; }));
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
      }

      // Update tooltip visibility after a tick
      setTimeout(updateTooltipVisibility, 100);
    }

    function autoSelectToday() {
      var now = new Date();
      var dd = String(now.getDate()).padStart(2, '0');
      var mm = String(now.getMonth() + 1).padStart(2, '0');
      var yyyy = now.getFullYear();
      var todayStr = dd + '/' + mm + '/' + yyyy;

      var hasToday = BLOCOS_DATA.blocos.some(function(b) { return b.dia === todayStr; });
      if (hasToday) {
        var pills = document.querySelectorAll('.date-pill');
        for (var i = 0; i < pills.length; i++) {
          if (pills[i].dataset.date === todayStr) {
            selectDate(todayStr, pills[i]);
            return true;
          }
        }
      }
      return false;
    }

    // ===== DETAIL PANEL (inline, below filters) =====
    function showBlocoDetail(bloco) {
      selectedBloco = bloco;
      var content = document.getElementById('detail-content');
      var panel = document.getElementById('detail-panel');
      var color = TYPE_COLORS[bloco.tipo] || '#6B7280';
      var hasRoute = bloco.trajeto_aproximado && bloco.trajeto_aproximado.length > 1;

      var horarioStr = bloco.horario;
      if (bloco.horario_fim) horarioStr += ' \u2013 ' + bloco.horario_fim;

      var parts = bloco.dia.split('/');
      var rgb = hexToRgb(color);

      content.innerHTML =
        '<div class="detail-header">' +
          '<div class="detail-info">' +
            '<span class="tipo-badge" style="color:' + color + ';background:rgba(' + rgb + ',0.12);">' + bloco.tipo + '</span>' +
            '<h2>' + bloco.nome + '</h2>' +
            '<p class="detail-bairro">' + bloco.bairro + '</p>' +
          '</div>' +
          '<button id="detail-close" onclick="hideDetail()">\u2715</button>' +
        '</div>' +
        '<div class="detail-meta">' +
          '<span><span class="meta-label">Data</span> ' + bloco.dia_semana + ', ' + parts[0] + '/' + parts[1] + '</span>' +
          '<span><span class="meta-label">Hora</span> ' + horarioStr + '</span>' +
          '<span><span class="meta-label">Local</span> ' + bloco.concentracao + '</span>' +
        '</div>' +
        (hasRoute ? '<button id="btn-route" onclick="toggleRoute()">Ver trajeto \u2192</button>' : '');

      panel.classList.add('visible');
      positionDetailPanel();
    }

    function hideDetail() {
      document.getElementById('detail-panel').classList.remove('visible');
      selectedBloco = null;
      clearRoute();
    }

    function positionDetailPanel() {
      // Position detail panel right below the type filter
      var typeFilter = document.getElementById('type-filter');
      var panel = document.getElementById('detail-panel');
      var top = typeFilter.offsetTop + typeFilter.offsetHeight;
      panel.style.top = top + 'px';
    }

    // ===== ROUTES =====
    var routeLoading = false;

    function toggleRoute() {
      var btn = document.getElementById('btn-route');
      if (activeRoute) {
        clearRoute();
        if (btn) btn.classList.remove('active');
        return;
      }
      if (routeLoading) return;
      if (!selectedBloco || !selectedBloco.trajeto_aproximado || selectedBloco.trajeto_aproximado.length < 2) return;

      var color = TYPE_COLORS[selectedBloco.tipo] || '#6B7280';
      var waypoints = selectedBloco.trajeto_aproximado;

      // Build OSRM URL: coordinates are lng,lat pairs separated by ;
      var coords = waypoints.map(function(p) { return p[1] + ',' + p[0]; }).join(';');
      var url = 'https://router.project-osrm.org/route/v1/foot/' + coords +
                '?overview=full&geometries=geojson&steps=false';

      if (btn) {
        btn.textContent = 'Carregando...';
        btn.disabled = true;
      }
      routeLoading = true;

      fetch(url)
        .then(function(res) { return res.json(); })
        .then(function(data) {
          routeLoading = false;
          if (btn) {
            btn.textContent = 'Ver trajeto \u2192';
            btn.disabled = false;
          }

          if (data.code !== 'Ok' || !data.routes || !data.routes.length) {
            // Fallback: draw straight line if OSRM fails
            drawFallbackRoute(waypoints, color, btn);
            return;
          }

          // OSRM returns GeoJSON coordinates as [lng, lat], convert to [lat, lng] for Leaflet
          var routeCoords = data.routes[0].geometry.coordinates.map(function(c) {
            return [c[1], c[0]];
          });

          // Draw the real route (solid line since it's accurate)
          activeRoute = L.polyline(routeCoords, {
            color: color,
            weight: 5,
            opacity: 0.85,
            lineCap: 'round',
            lineJoin: 'round'
          }).addTo(map);

          addRouteMarkers(waypoints, color);
          map.fitBounds(activeRoute.getBounds(), { padding: [80, 80] });
          if (btn) btn.classList.add('active');
        })
        .catch(function() {
          routeLoading = false;
          if (btn) {
            btn.textContent = 'Ver trajeto \u2192';
            btn.disabled = false;
          }
          // Fallback on network error
          drawFallbackRoute(waypoints, color, btn);
        });
    }

    function drawFallbackRoute(waypoints, color, btn) {
      // Dashed line to indicate approximate route
      activeRoute = L.polyline(waypoints, {
        color: color,
        weight: 4,
        opacity: 0.85,
        dashArray: '8, 8',
        lineCap: 'round'
      }).addTo(map);

      addRouteMarkers(waypoints, color);
      map.fitBounds(activeRoute.getBounds(), { padding: [80, 80] });
      if (btn) btn.classList.add('active');
    }

    function addRouteMarkers(waypoints, color) {
      // Start marker
      var start = waypoints[0];
      var startMarker = L.circleMarker(start, {
        radius: 8,
        fillColor: color,
        fillOpacity: 1,
        color: '#fff',
        weight: 3
      }).addTo(map);
      startMarker.bindTooltip('Concentra\u00e7\u00e3o', {
        permanent: true,
        direction: 'top',
        offset: [0, -10],
        className: 'bloco-tooltip'
      });
      activeRouteMarkers.push(startMarker);

      // End marker
      var end = waypoints[waypoints.length - 1];
      if (end[0] !== start[0] || end[1] !== start[1]) {
        var endMarker = L.circleMarker(end, {
          radius: 6,
          fillColor: color,
          fillOpacity: 0.6,
          color: '#fff',
          weight: 2.5
        }).addTo(map);
        endMarker.bindTooltip('Fim', {
          permanent: true,
          direction: 'top',
          offset: [0, -8],
          className: 'bloco-tooltip'
        });
        activeRouteMarkers.push(endMarker);
      }
    }

    function clearRoute() {
      if (activeRoute) {
        map.removeLayer(activeRoute);
        activeRoute = null;
      }
      activeRouteMarkers.forEach(function(m) { map.removeLayer(m); });
      activeRouteMarkers = [];
    }

    // ===== GEOLOCATION =====
    function locateUser() {
      var btn = document.getElementById('btn-locate');
      if (!navigator.geolocation) {
        alert('Geolocaliza\u00e7\u00e3o n\u00e3o dispon\u00edvel no seu navegador');
        return;
      }

      btn.classList.add('active');

      navigator.geolocation.getCurrentPosition(
        function(pos) {
          var latlng = [pos.coords.latitude, pos.coords.longitude];

          if (userMarker) {
            userMarker.setLatLng(latlng);
            userRing.setLatLng(latlng);
          } else {
            // Pulsing rings - 2 concentric, different speeds
            userRing = L.marker(latlng, {
              icon: L.divIcon({
                className: '',
                html: '<div class="user-pulse-container"><div class="user-ring-inner"></div><div class="user-ring-outer"></div></div>',
                iconSize: [100, 100],
                iconAnchor: [50, 50]
              }),
              interactive: false,
              zIndexOffset: 500
            }).addTo(map);

            // Dot - prominent
            userMarker = L.circleMarker(latlng, {
              radius: 9,
              fillColor: '#007AFF',
              fillOpacity: 1,
              color: '#fff',
              weight: 4
            }).addTo(map);
            userMarker.setZIndexOffset && userMarker.bringToFront();
          }

          map.setView(latlng, 15, { animate: true });
        },
        function(err) {
          btn.classList.remove('active');
          alert('N\u00e3o foi poss\u00edvel obter sua localiza\u00e7\u00e3o.\nVerifique as permiss\u00f5es do navegador.');
        },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    }

    // ===== EVENT LISTENERS =====
    function setupEventListeners() {
      document.getElementById('btn-locate').addEventListener('click', locateUser);
    }

    // ===== BOOT =====
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
